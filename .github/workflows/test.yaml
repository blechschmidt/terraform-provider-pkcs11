name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Build
        run: go build ./...
      - name: Vet
        run: go vet ./...
      - name: Unit tests
        run: go test ./...

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false

      - name: Install SoftHSM
        run: |
          sudo apt-get update
          sudo apt-get install -y softhsm2

      - name: Initialize SoftHSM token
        run: |
          mkdir -p "$HOME/.config/softhsm2/tokens"
          cat > "$HOME/.config/softhsm2/softhsm2.conf" <<EOF
          directories.tokendir = $HOME/.config/softhsm2/tokens
          objectstore.backend = file
          log.level = WARNING
          EOF
          export SOFTHSM2_CONF="$HOME/.config/softhsm2/softhsm2.conf"
          softhsm2-util --init-token --free --label TestToken --pin 1234 --so-pin 5678
          echo "SOFTHSM2_CONF=$SOFTHSM2_CONF" >> "$GITHUB_ENV"

      - name: Run integration tests
        run: |
          chmod +x tests/run_tests.sh
          HSM=softhsm PKCS11_MODULE=/usr/lib/softhsm/libsofthsm2.so ./tests/run_tests.sh
